#!/bin/bash
set -e

DAYS_OLD=7

echo "âœ… Ollama is up to date (v0.6.6 assumed)."

# --- Update models if they're old ---
echo ""
echo "ğŸ”„ Checking model freshness..."
models=(llama3 codellama gemma3 mistral)

for model in "${models[@]}"; do
  modified=$(ollama list | grep "$model" | awk '{print $(NF-1), $NF}')
  if [[ -z "$modified" ]]; then
    echo "â¬‡ï¸ $model not found â€” pulling fresh copy..."
    ollama pull "$model"
    continue
  fi

  timestamp=$(date -d "$modified" +%s 2>/dev/null || gdate -d "$modified" +%s)
  now=$(date +%s)
  age_days=$(( (now - timestamp) / 86400 ))

  if [[ $age_days -ge $DAYS_OLD ]]; then
    echo "â³ $model is $age_days days old â€” updating..."
    ollama pull "$model"
  else
    echo "âœ… $model is recent ($age_days days old) â€” skipping."
  fi
done

# --- Prompt for cleanup ---
echo ""
read -p "ğŸ§¹ Remove unused models via fzf? [y/N]: " confirm
if [[ "$confirm" =~ ^[Yy]$ ]]; then
  echo "â†’ Select models to delete (use space to select, Enter to confirm):"
  to_delete=$(ollama list | awk '{print $1}' | fzf --multi)

  if [[ -n "$to_delete" ]]; then
    echo "$to_delete" | xargs -n1 ollama rm
    echo "ğŸ—‘ï¸ Models removed."
  else
    echo "âš ï¸ No models selected."
  fi
else
  echo "ğŸ›‘ Skipping model cleanup."
fi

# --- Done ---
echo ""
echo "âœ… Finished. Current models:"
ollama list
